var Le = Object.defineProperty, we = Object.defineProperties;
var $e = Object.getOwnPropertyDescriptors;
var w = Object.getOwnPropertySymbols;
var J = Object.prototype.hasOwnProperty, Q = Object.prototype.propertyIsEnumerable;
var G = (o, i, a) => i in o ? Le(o, i, { enumerable: !0, configurable: !0, writable: !0, value: a }) : o[i] = a, B = (o, i) => {
  for (var a in i || (i = {}))
    J.call(i, a) && G(o, a, i[a]);
  if (w)
    for (var a of w(i))
      Q.call(i, a) && G(o, a, i[a]);
  return o;
}, D = (o, i) => we(o, $e(i));
var X = (o, i) => {
  var a = {};
  for (var p in o)
    J.call(o, p) && i.indexOf(p) < 0 && (a[p] = o[p]);
  if (o != null && w)
    for (var p of w(o))
      i.indexOf(p) < 0 && Q.call(o, p) && (a[p] = o[p]);
  return a;
};
import r, { useState as k, useRef as y, useEffect as Y, useLayoutEffect as Re, Children as Z, cloneElement as Se } from "react";
import e from "prop-types";
import Be from "@strapi/icons/CarretDown";
import De from "@strapi/icons/Cross";
import { useId as Fe } from "../helpers/useId.js";
import { filterOptions as ee, maintainScrollVisibility as Te, getActionFromKey as Ae, MenuActions as h, getUpdatedIndex as F } from "./utils.js";
import { Flex as te } from "../Flex/Flex.js";
import { IconBox as Pe, CaretBox as Ve } from "../Select/components.js";
import { Popover as Ke } from "../Popover/Popover.js";
import { Box as Ne } from "../Box/Box.js";
import { Typography as oe } from "../Typography/Typography.js";
import { Loader as He } from "../Loader/Loader.js";
import { MainRow as Ue, InputContainer as _e, ValueContainer as je, Input as qe } from "./components.js";
import { ComboboxOption as ze } from "./ComboboxOption.js";
import { ComboboxList as We } from "./ComboboxList.js";
import { Field as Ge } from "../Field/Field.js";
import { FieldLabel as Je } from "../Field/FieldLabel.js";
import "../Field/FieldInput.js";
import { FieldHint as Qe } from "../Field/FieldHint.js";
import { FieldError as Xe } from "../Field/FieldError.js";
import "../Field/FieldContext.js";
import "../Field/FieldAction.js";
import { Stack as Ye } from "../Stack/Stack.js";
import { KeyboardKeys as Ze } from "../helpers/keyboardKeys.js";
import { VisuallyHidden as et } from "../VisuallyHidden/VisuallyHidden.js";
const O = (tt) => {
  var N = tt, {
    children: o,
    clearLabel: i,
    creatable: a,
    createMessage: p,
    disabled: u,
    error: $,
    hasMoreItems: ne,
    hint: T,
    label: E,
    labelAction: ae,
    loading: R,
    loadingMessage: ie,
    noOptionsMessage: le,
    onChange: A,
    onClear: P,
    onCreateOption: se,
    onInputChange: V,
    onLoadMore: ce,
    placeholder: pe,
    required: K,
    value: m
  } = N, de = X(N, [
    "children",
    "clearLabel",
    "creatable",
    "createMessage",
    "disabled",
    "error",
    "hasMoreItems",
    "hint",
    "label",
    "labelAction",
    "loading",
    "loadingMessage",
    "noOptionsMessage",
    "onChange",
    "onClear",
    "onCreateOption",
    "onInputChange",
    "onLoadMore",
    "placeholder",
    "required",
    "value"
  ]);
  const fe = () => {
    var t;
    return (t = o.find((n) => {
      var l;
      return ((l = n.props) == null ? void 0 : l.value.toLowerCase()) === m.toLowerCase();
    }).props) == null ? void 0 : t.children;
  }, [c, H] = k(0), [ue, me] = k(null), [f, U] = k(o), [g, be] = k(!1), [s, M] = k(""), x = y(), L = y(!1), I = y(), _ = y(), ge = y(), j = y(!0), d = Fe("combobox"), q = `${d}-label`;
  if (!E && !de["aria-label"])
    throw new Error('The Combobox component needs a "label" or an "aria-label" props');
  Y(() => {
    U(ee(o, s));
  }, [s, o]), Y(() => {
    g && x.current && Te(x.current);
  }, [c, g]), Re(() => {
    j.current && (j.current = !1);
  }, [m]);
  const Ce = g ? `${d}-${c}` : "", z = () => {
    A(null), M("");
  }, he = (t) => {
    V && V(t);
    const n = I.current.value;
    U(ee(o, n)), H(0), me(null), s !== n && M(n), g || b(!0, !1);
  }, Ee = (t) => {
    const { key: n } = t, l = a && s ? f.length : f.length - 1, v = Ae(n, g);
    switch (m && !s && n === Ze.BACKSPACE && z(), v) {
      case h.Next: {
        if (c === l) {
          C(0);
          break;
        }
        C(F(c, l, v));
        break;
      }
      case h.Previous: {
        if (c === 0) {
          C(l);
          break;
        }
        C(F(c, l, v));
        break;
      }
      case h.Last:
      case h.First: {
        if (c === l) {
          C(0);
          break;
        }
        C(F(c, l, v));
        break;
      }
      case h.CloseSelect:
        t.preventDefault(), S(c);
        break;
      case h.Close:
        t.preventDefault(), b(!1);
        break;
      case h.Open:
        b(!0);
        break;
    }
  }, xe = (t) => {
    if (t.preventDefault(), m && !L.current && M(""), L.current) {
      L.current = !1;
      return;
    }
    b(!1, !1);
  }, C = (t) => {
    H(t);
  }, ve = (t) => {
    C(t), S(t);
  }, W = () => {
    L.current = !0;
  }, S = (t) => {
    const n = f[t];
    if (M(""), n) {
      A(n.props.value), b(!1);
      return;
    }
    a && (se(s), b(!1));
  }, b = (t, n = !0) => {
    be(t), n && I.current.focus();
  }, ye = Z.toArray(f).map((t, n) => {
    const l = c === n;
    return Se(t, {
      id: `${d}-${n}`,
      "aria-selected": ue === n,
      "aria-posinset": n + 1,
      "aria-setsize": Z.toArray(f).length,
      ref(v) {
        l && (x.current = v);
      },
      onClick: () => ve(n),
      onMouseDown: W,
      isSelected: l
    });
  }), Ie = () => {
    I.current.focus(), P && P(), z();
  }, ke = () => {
    I.current.focus(), b(!0);
  }, Oe = () => {
    const t = f.findIndex((n) => {
      var l;
      return ((l = n.props) == null ? void 0 : l.children) === s;
    });
    return s && t === -1;
  }, Me = (t) => {
    t.preventDefault(), b(t, !0);
  };
  return /* @__PURE__ */ r.createElement(Ge, {
    hint: T,
    error: $,
    id: d,
    required: K
  }, /* @__PURE__ */ r.createElement(et, {
    "aria-live": "polite",
    "aria-atomic": "false",
    "aria-relevant": "additions text"
  }, m), /* @__PURE__ */ r.createElement(Ye, {
    spacing: E || T || $ ? 1 : 0
  }, E && /* @__PURE__ */ r.createElement(Je, {
    action: ae
  }, E), /* @__PURE__ */ r.createElement(Ue, {
    ref: _,
    $disabled: u,
    hasError: $
  }, /* @__PURE__ */ r.createElement(_e, {
    wrap: "wrap"
  }, !s && m && /* @__PURE__ */ r.createElement(je, {
    id: `${d}-selected-value`
  }, /* @__PURE__ */ r.createElement(oe, null, fe())), /* @__PURE__ */ r.createElement(qe, {
    "aria-activedescendant": Ce,
    "aria-autocomplete": "list",
    "aria-controls": `${d}-listbox`,
    "aria-disabled": u,
    "aria-expanded": g,
    "aria-haspopup": "listbox",
    "aria-labelledby": E ? q : void 0,
    autoComplete: "off",
    autoCorrect: "off",
    id: d,
    onBlur: u ? void 0 : xe,
    onClick: u ? void 0 : Me,
    onInput: u ? void 0 : he,
    onKeyDown: u ? void 0 : Ee,
    placeholder: m ? "" : pe,
    readOnly: u,
    ref: I,
    required: K,
    role: "combobox",
    spellCheck: "off",
    type: "text",
    value: s
  })), /* @__PURE__ */ r.createElement(te, null, (m || s) && /* @__PURE__ */ r.createElement(Pe, {
    id: `${d}-clear`,
    "aria-label": i,
    disabled: u,
    paddingLeft: 3,
    as: "button",
    onClick: Ie,
    type: "button"
  }, /* @__PURE__ */ r.createElement(De, null)), /* @__PURE__ */ r.createElement(Ve, {
    disabled: u,
    paddingLeft: 3,
    "aria-hidden": !0,
    as: "button",
    onClick: ke,
    tabIndex: -1,
    type: "button"
  }, /* @__PURE__ */ r.createElement(Be, null)))), /* @__PURE__ */ r.createElement(Qe, null), /* @__PURE__ */ r.createElement(Xe, null)), g && /* @__PURE__ */ r.createElement(Ke, {
    id: `${d}-popover`,
    source: _,
    spacing: 4,
    fullWidth: !0,
    intersectionId: `${d}-listbox-popover-intersection`,
    onReachEnd: ne && !R ? ce : void 0
  }, /* @__PURE__ */ r.createElement("div", {
    role: "listbox",
    ref: ge,
    id: `${d}-listbox`,
    "aria-labelledby": E ? q : void 0
  }, (Boolean(f.length) || a) && /* @__PURE__ */ r.createElement(r.Fragment, null, /* @__PURE__ */ r.createElement(We, {
    activeOptionRef: x,
    options: ye
  }), Oe() && a && /* @__PURE__ */ r.createElement(ze, {
    isSelected: c === f.length,
    ref: (t) => {
      c === f.length && (x.current = t);
    },
    onMouseDown: W,
    onClick: () => S(),
    taindex: 0
  }, p(s))), !f.length && !a && !R && /* @__PURE__ */ r.createElement(Ne, {
    paddingLeft: 4,
    paddingRight: 4,
    paddingTop: 2,
    paddingBottom: 2,
    ref: x
  }, /* @__PURE__ */ r.createElement(oe, {
    textColor: "neutral800"
  }, le(s))), R && /* @__PURE__ */ r.createElement(te, {
    justifyContent: "center",
    alignItems: "center",
    paddingTop: 2,
    paddingBottom: 2
  }, /* @__PURE__ */ r.createElement(He, {
    small: !0
  }, ie)))));
}, re = (o) => /* @__PURE__ */ r.createElement(O, D(B({}, o), {
  creatable: !0
}));
O.defaultProps = {
  "aria-label": void 0,
  clearLabel: "clear",
  creatable: !1,
  createMessage: (o) => `Create "${o}"`,
  disabled: !1,
  error: void 0,
  hasMoreItems: !1,
  hint: void 0,
  label: void 0,
  loading: !1,
  loadingMessage: "Loading content...",
  noOptionsMessage: () => "No results found",
  onClear: void 0,
  onCreateOption: void 0,
  onInputChange: void 0,
  onLoadMore: void 0,
  placeholder: "Select or enter a value",
  value: void 0
};
re.defaultProps = O.defaultProps;
O.propTypes = {
  "aria-label": e.string,
  children: e.oneOfType([e.arrayOf(e.node), e.node]),
  clearLabel: e.string,
  creatable: e.bool,
  createMessage: e.func,
  disabled: e.bool,
  error: e.string,
  hasMoreItems: e.bool,
  hint: e.oneOfType([e.string, e.node, e.arrayOf(e.node)]),
  label: e.string,
  labelAction: e.element,
  loading: e.bool,
  loadingMessage: e.string,
  noOptionsMessage: e.func,
  onChange: e.func.isRequired,
  onClear: e.func,
  onCreateOption: e.func,
  onInputChange: e.func,
  onLoadMore: e.func,
  placeholder: e.string,
  value: e.string
};
re.propTypes = D(B({}, O.propTypes), {
  onCreateOption: e.func.isRequired
});
export {
  O as Combobox,
  re as CreatableCombobox
};
